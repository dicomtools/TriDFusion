function resize = dicomViewer()
%function resize = dicomViewer()
%Dicom Viewer Main Function.
%See TriDFuison.doc (or pdf) for more information about options.
%
%Author: Daniel Lafontaine, lafontad@mskcc.org
%
%Last specifications modified:
%
% Copyright 2020, Daniel Lafontaine, on behalf of the TriDFusion development team.
%
% This file is part of The Triple Dimention Fusion (TriDFusion).
%
% TriDFusion development has been led by:  Daniel Lafontaine
%
% TriDFusion is distributed under the terms of the Lesser GNU Public License.
%
%     This version of TriDFusion is free software: you can redistribute it and/or modify
%     it under the terms of the GNU General Public License as published by
%     the Free Software Foundation, either version 3 of the License, or
%     (at your option) any later version.
%
% TriDFusion is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
% without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
% See the GNU General Public License for more details.
%
% You should have received a copy of the GNU General Public License
% along with TriDFusion.  If not, see <http://www.gnu.org/licenses/>.

    resize = @resizeFigure;

    enableErrorLogging('set', true);

    aspectRatio     ('set', true);
    isShading       ('set', false);
    isInterpolated  ('set', false);
    gateUseSeriesUID('set', true);
    gateLookupTable ('set', true);
    gateLookupType  ('set', 'Relative');
    vSplahView      ('set', 'Axial');

%    imageOrientation('set', 'axial');

    suvWindowLevel('set', 'max', 7);
    suvWindowLevel('set', 'min', 0);

    fusionWindowLevel('set', 'max', 0);
    fusionWindowLevel('set', 'min', 0);
%
%     fusionSliderLevel('set', 'max', 0);
%     fusionSliderLevel('set', 'min', 0);

    link2DMip('set', true);

    windowLevel('set', 'max', 0);
    windowLevel('set', 'min', 0);

    colorbarScale      ('set', 100);
    fusionColorbarScale('set', 100);

    kernelCtSerieOffset        ('set', 1);
    kernelUseCtDoseMap         ('set', false);
    kernelUnitTypeWindow       ('set', false);
    kernelSegTreshValue        ('set', 'lower', 0);
    kernelSegTreshValue        ('set', 'upper', 1);
    kernelMethod               ('set', 1); % Local Deposition
    kernelInterpolation        ('set', 'Linear');
    kernelCutoff               ('set', 99.9305); % mm
    kernelMicrosphereInSpecimen('set', false);

    resizePixelSizeDoseInformationDialog('set', false);

    resizeVoxelDoseInformationDialog('set', 'x', 0.1); % mm
    resizeVoxelDoseInformationDialog('set', 'y', 0.1); % mm
    resizeVoxelDoseInformationDialog('set', 'z', 0.1); % mm

    isSameSpacingDoseInformationDialog('set', true);

    treatmentTypeDoseInformationDialog('set', 1); % TheraSphere

    microspereVolumeDoseInformationDialog('set', 8.1E-9); % In cm3
    specimenVolumeDoseInformationDialog  ('set', 0   ); % In ml

    imageSegTreshValue('set', 'lower', 0);
    imageSegTreshValue('set', 'upper', 1);
    lungSegTreshValue ('set', 0.2       );
    lungSegRadiusValue('set', 3         );

    edgeSegMethod      ('set', 'canny');
    fudgeFactorSegValue('set', 0.95   );

    invertConstraint('set', false);

    contourVisibilityRoiPanelValue('set', true);

    minThresholdRoiPanelValue('set', true, '', 0);
    maxThresholdRoiPanelValue('set', true, '', 0);

    minThresholdSliderRoiPanelValue('set', 0   );
    maxThresholdSliderRoiPanelValue('set', 0.41);

    roiFaceAlphaValue('set', 0);
    mipFaceAlphaValue('set', 0.7);

    plotEditColor('set', [0.482,1,0.149]);
    plotEditFontAngle('set', 'Normal');
    plotEditFontWeight('set', 'Normal');
    plotEditFontName('set', 'Helvetica');
    plotEditFontSize('set', 12);

    crossSize              ('set', 10     );
    crossColor             ('set', viewerCrossLinesColor('get'));
    crossActivate          ('set',  true  );
    overlayActivate        ('set',  true  );
    overlayColor           ('set', 'black');
    windowButton           ('set', 'up'   );
    invertColor            ('set', true   );
    backgroundColor        ('set', viewerAxesColor('get') );
    background3DOffset     ('set', 7 ); % white
    colorMapOffset         ('set', 9);
    fusionColorMapOffset   ('set', 19); % Hot Iron
    volLinearAlphaValue    ('set', 1 );
    volLinearFusionAlphaValue('set', 1);
    getVolAlphaMap         ('set', '', 'auto');
    getVolFusionAlphaMap   ('set', '', 'auto');
    colorMapVolOffset      ('set', 22); % angio
    colorMapVolFusionOffset('set', 22); % angio
    colorMapMipOffset      ('set', 9); % gray
    colorMapMipFusionOffset('set', 9); % gray
    mipLinearAlphaValue    ('set', 1 );
    mipLinearFuisonAlphaValue('set', 1);
    getMipAlphaMap         ('set', '', 'auto');
    getMipFusionAlphaMap   ('set', '', 'auto');
    mipFusionBufferOffset  ('set', 1);

    isoColorOffset        ('set', 4  ); % red
    isoSurfaceValue       ('set', 0.1);
    isoColorFusionOffset  ('set', 4  ); % red
    isoSurfaceFusionValue ('set', 0.1);
    addVoiIsoMask         ('set', true);
    percentOfPeakIsoMask  ('set', true); % In percent or SUV
    multiplePeaksIsoMask  ('set', false);
    peakSUVMaxIsoMask     ('set', 4);  % In SUV
    peakPercentIsoMask    ('set', 65); % In percent
    voiIsoMaskMax         ('set', 41); % In percent
    smalestIsoMask        ('set', 0.3); % In ml
    valueFormulaIsoMask   ('set', 1); %Fixed suv value
    resampleToCTIsoMask   ('set', true);
    resampledContoursIsoMask('set', true);
    isoMaskCtSerieOffset  ('set', 1);

    volLighting           ('set', true);
    volFusionLighting     ('set', true);

    background3DGradient  ('set', true);

    volume3DZOffset  ('set', false);

    %       surfaceAlpha    ('set', 1       );
    sliderWindowLevelValue      ('set', 'max', 0.5);
    sliderWindowLevelValue      ('set', 'min', 0.5);
    sliderFusionWindowLevelValue('set', 'max', 0.5);
    sliderFusionWindowLevelValue('set', 'min', 0.5);
    sliderAlphaValue            ('set', 0.5);

    vSplashLayout('set', 'x', 5);
    vSplashLayout('set', 'y', 3);

    zoomTool         ('set', false);
    rotate3DTool     ('set', false);
    dataCursorTool   ('set', false);
    panTool          ('set', false);
    editPlot         ('set', false);
    editToolbar      ('set', false);
    camToolbar       ('set', false);
    playback3DToolbar('set', false);
    roiToolbar       ('set', false);
    plotEditToolbar  ('set', false);

    % playback2DMipOnly('set', true);
    linkCoronalWithSagittal('set', true);

    multiFrameSpeed   ('set', 0.15 );
    multiFramePlayback('set', false);
    multiFrameRecord  ('set', false);
    multiFrameZoom    ('set', 'in' , 1);
    multiFrameZoom    ('set', 'out', 1);
    multiFrameZoom    ('set', 'axe', []);

    multiFrame3DSpeed   ('set', 0.05 );
    multiFrame3DIndex   ('set', 1    );
    multiFrame3DPlayback('set', false);
    multiFrame3DRecord  ('set', false);
    multiFrame3DZoom    ('set', 0    );

    export3DSliceThickess('set', 1);

    voi3DEnableList             ('set', '');
    voi3DTransparencyList       ('set', '');
    voi3DRenderer               ('set', 'VolumeRendering');
    slider3DVoiTransparencyValue('set', 0.75);
    voi3DSmooth                 ('set', true);

    gaussFilter('set', false);

    gaussFilterValue('set', 'x', 0.1);
    gaussFilterValue('set', 'y', 0.1);
    gaussFilterValue('set', 'z', 1  );

    displayVoi('set', false);

    displayVolColorMap('set', false);
    displayMIPColorMap('set', false);

    switchTo3DMode    ('set', false);
    switchToIsoSurface('set', false);
    switchToMIPMode   ('set', false);

    initWindowLevel      ('set', true);
    initFusionWindowLevel('set', true);

    getRGBColormapImage('set', 'rgb-plus.png');

    isfigVoiSimplified           ('set', false);
    isfigVoiExpendVoi            ('set', false);
    suvMenuUnitOption            ('set', true);
    segMenuOption                ('set', false);
    modifiedMatrixValueMenuOption('set', false);
    isFigRoiInColor              ('set', true);
    centroidMenuOption           ('set', false);

    registrationTemplate('init');
    registrationReport  ('set', '');

    updateDescription            ('set', true);
    referenceOutputView          ('set', true);
    associateRegistrationModality('set', true);

    roiPanelCtSerieOffset     ('set', 1);
    roiPanelUseCt             ('set', false);
    roiPanelUnitTypeWindow    ('set', false);
    smalestRegionRoiPanelValue('set', 3);
    multipleObjectsRoiPanel   ('set', true);
    pixelEdge                 ('set', true);
    holesRoiPanel             ('set', false);

    voiIncrementRatio('set', 2.5); % in mm

    % Machine Learning

    fastMachineLearningDialog      ('set', true);
    forceSplitMachineLearningDialog('set', true);
    bodySegMachineLearningDialog   ('set', true);

    viewFarthestDistances('set', false);

    isShowTextContours('set', 'axe'     , true );
    isShowTextContours('set', 'coronal' , false);
    isShowTextContours('set', 'sagittal', false);
    isShowTextContours('set', 'axial'   , true );
    isShowTextContours('set', 'mip'     , false);

    default2DPlaybackPlane('set', 'mip');

    isShowFaceAlphaContours('set', true);
    plotContoursLineWidth('set', 1);

    updateDicomWriteSeriesInstanceUID('set', true);
    modifiedImagesContourMatrix('set', false);

    sphereDefaultDiameter ('set', 25); % in mm
    brush2dDefaultDiameter('set', 30); % in mm
    clickVoiPreSegmentationValue('set', 0); % In Perent
    clickVoiPercentOfMaxValue('set', 41); % In Perent

    mipAngle('set', 1);

    rng('shuffle');

    % Set ISOsurface default value. Those value will be use in
    % setIsoSurfaceCallback(~, ~). The default value are restored in
    % setSeriesCallback() and setSourceCallback().

    defaultIsoColorOffset       ('set', isoColorOffset('get')       );
    defaultIsoSurfaceValue      ('set', isoSurfaceValue('get')      );
    defaultIsoColorFusionOffset ('set', isoColorFusionOffset('get') );
    defaultIsoSurfaceFusionValue('set', isoSurfaceFusionValue('get'));

    % Radiomics

    radiomicsEntireVolume('set', true);
    radiomicsContourType('set', true);

    % Contour Margin

    contourMarginDistanceValue('set', 10); % In mm
    contourMarginJointType('set', 'miter');

    % HAI Zoning

    haiZoningMarginDistanceValue('set', 5); % In mm

    % Liver Ablation

    liverAblationMarginDistanceValue('set', 10); % In mm
    liverAblationMarginJointType('set', 'miter');

    % 3D Lung Shunt

    lungShuntLiverVolumeOversized          ('set',  3); % Pixel(s) offset
    lungShuntLiverTopOfVolumeExtraSlices   ('set',  1); % Slice cutoff
    lungShuntLiverBottomOfVolumeExtraSlices('set',  2); % Slice cutoff
    lungShuntLungsVolumeOversized          ('set',  1); % Pixel(s) offset
    lungShuntLungsVolumeOverlap            ('set', false); % Lungs liver overlap

    % 3D Lung Lobes

    lungLobesLiverVolumeOversized       ('set', 0); % Pixel(s) offset
    lungLobesLiverTopOfVolumeExtraSlices('set', 0); % Slice cutoff

    % FDG segmentation

    FDGSmoothMaskValue('set', false);

    FDGSegmentationSUVThresholdValue     ('set', 4); % SUV
    FDGSegmentationBoneSUVThresholdValue ('set', 4); % SUV
    FDGSegmentationPercentOfPeakValue    ('set', 41); % Percent
    FDGSegmentationMultiplePeaksValue    ('set', 65); % Percent
    FDGSegmentationBoneMaskThresholdValue('set', 200); % HU
    FDGSegmentationBoundaryPercentValue  ('set', 10);
    FDGSmalestVoiValue('set', 0.3);

    excludeLymphNodeSUVBrain         ('set', true);
    excludeLymphNodeSUVUrinaryBladder('set', true);
    excludeLymphNodeSUVKidneyLeft    ('set', false);
    excludeLymphNodeSUVKidneyRight   ('set', false);
    excludeLymphNodeSUVSmallBowel    ('set', false);
    segmentLymphNodeSUVSpleen        ('set', true);

    % Mantle Cell Lymphoma

    excludeMantleCellLymphomaSkeleton('set', true);
    excludeMantleCellLymphomaCardiovascular('set', true);
    excludeMantleCellLymphomaBrain('set', true);
    excludeMantleCellLymphomaSpinalCord('set', true);
    excludeMantleCellLymphomaAdrenalGlandLeft('set', true);
    excludeMantleCellLymphomaAdrenalGlandRight('set', true);
    excludeMantleCellLymphomaSpleen('set', true);
    excludeMantleCellLymphomaGallbladder('set', true);
    excludeMantleCellLymphomaKidneyLeft('set', true);
    excludeMantleCellLymphomaKidneyRight('set', true);
    excludeMantleCellLymphomaProstate('set', true);
    excludeMantleCellLymphomaGastrointestalTract('set', true);

    mantleCellLymphomaSmalestVoiValue('set', 0.3);
    mantleCellLymphomaPercentOfLiverMax('set', 10);

    % Breast Cancer

    breastCancerSmalestVoiValue('set', 0.3);
    breastCancerSegmentationBoneMaskThresholdValue('set', 200);
    breastCancerSegmentationSUVThresholdValue('set', 4);
    breastCancerSegmentationBoneSUVThresholdValue('set', 3);

    machineLearningBreastCancerCELoss('set', true);
    machineLearningBreastCancerClassifySegmentation('set', true);
    machineLearningBreastCancerSmoothMask('set', false);
    machineLearningBreastCancerSmallestVoiValue('set', 0);

    % Brown fat

    FDGBrownFatSUVType                 ('set', 'LBM');
    FDGBrownFatSUVThresholdValue       ('set', 1.2); % SUV
    FDGBrownFatHUThresholdValue        ('set', -500, 500); % HU
    FDGBrownFatSmalestVoiValue         ('set', 0.1);

    excludeBrownFatSUVBrain            ('set', true);
    excludeBrownFatSUVHeart            ('set', true);
    excludeBrownFatSUVLungs            ('set', true);
    excludeBrownFatSUVKidneyLeft       ('set', true);
    excludeBrownFatSUVKidneyRight      ('set', true);
    excludeBrownFatSUVLiver            ('set', true);
    excludeGa68DOTATATETrachea         ('set', true);
    excludeBrownFatSUVAdrenalGlandLeft ('set', true);
    excludeBrownFatSUVAdrenalGlandRight('set', true);
    excludeBrownFatSUVSpleen           ('set', true);
    excludeBrownFatSUVGallbladder      ('set', true);
    excludeBrownFatSUVPancreas         ('set', true);

    excludeBrownFatSUVEsophagus        ('set', true);
    excludeBrownFatSUVStomach          ('set', true);
    excludeBrownFatSUVDuodenum         ('set', true);
    excludeBrownFatSUVSmallBowel       ('set', true);
    excludeBrownFatSUVColon            ('set', true);

    excludeBrownFatSUVSkeleton         ('set', true);

    machineLearningFDGBrownFatSUVScaled('set', true);
    machineLearningFDGBrownFatSUVNormalization('set', false);
    machineLearningFDGBrownFatSmoothMask('set', false);
    machineLearningFDGBrownFatClassifySegmentation('set', true);
    machineLearningFDGBrownFatCELoss('set', true);
    machineLearningFDGBrownFatSmallestVoiValue('set', 0);
    machineLearningFDGBrownFatFastSegmentation('set', false);

    % FDHT segmentation

    FDHTSegmentationBoneMaskThresholdValue('set', 100); % HU
%     FDHTSegmentationBoundaryPercentValue('set', 10);
    FDHTNormalLiverSDValue('set', 0.4);
    FDHTNormalLiverMeanValue('set', 4);
    FDHTSmalestVoiValue('set', 0.3);

    excludeFDHTBrain('set', true);
    excludeFDHTUrinaryBladder('set', true);
    excludeFDHTKidneyLeft('set', true);
    excludeFDHTKidneyRight('set', true);
    excludeFDHTSmallBowel('set', true);
    excludeFDHTSpleen('set', true);

    % Lu177 segmentation

    Lu177SegmentationBoneMaskThresholdValue('set', 150); % HU
%     Lu177SegmentationBoundaryPercentValue('set', 20);
    Lu177NormalLiverSDValue('set', 0.4);
    Lu177NormalLiverMeanValue('set', 4);
    Lu177SmalestVoiValue('set', 0.3);
    Lu177LymphNodesSUVThresholdValue('set', 4);
    Lu177SoftTissueSUVThresholdValue('set', 4);
    Lu177BoneSUVThresholdValue('set', 4);
    Lu177LymphNodesSegmentation('set', true);
    Lu177BoneSegmentation('set', true);

    excludeLu177Brain         ('set', true);
    excludeLu177UrinaryBladder('set', true);
    excludeLu177KidneyLeft    ('set', true);
    excludeLu177KidneyRight   ('set', true);
    excludeLu177SmallBowel    ('set', false);
    excludeLu177Spleen        ('set', true);

    % PSMA Lu177 Segmentation

    machineLearningPSMALu177CELoss('set', true);
    machineLearningPSMALu177ClassifySegmentation('set', true);
    machineLearningPSMALu177SmoothMask('set', false);
    machineLearningPSMALu177SmallestVoiValue('set', 0);
    machineLearningPSMALu177FastSegmentation('set', false);

    % PSMA segmentation

    PSMASegmentationBoneMaskThresholdValue('set', 150); % HU
%     PSMASegmentationBoundaryPercentValue('set', 10);
    PSMANormalLiverSDValue  ('set', 0.4);
    PSMANormalLiverMeanValue('set', 4);
    PSMASmalestVoiValue     ('set', 0.3);
    PSMALymphNodesSUVThresholdValue('set', 4);
    PSMASoftTissueSUVThresholdValue('set', 4);
    PSMABoneSUVThresholdValue('set', 4);
    PSMALymphNodesSegmentation('set', true);
    PSMABoneSegmentation('set', true);
    PSMAExcludeOrgansFromSegmentation('set', false);
    PSMAExcludeOrganMarginsValue('set', 10); % pixels

    excludePSMABrain         ('set', true);
    excludePSMAUrinaryBladder('set', true);
    excludePSMAKidneyLeft    ('set', true);
    excludePSMAKidneyRight   ('set', true);
    excludePSMASmallBowel    ('set', true);
    excludePSMASpleen        ('set', true);
    excludePSMALiver         ('set', true);
    excludePSMADuodenum      ('set', true);
    excludePSMAStomach       ('set', true);
    excludePSMAColon         ('set', true);

    % PSMA Ga68 Segmentation

    machineLearningPSMAGa68CELoss('set', false);
    machineLearningPSMAGa68ClassifySegmentation('set', true);
    machineLearningPSMAGa68SmoothMask('set', false);
    machineLearningPSMAGa68SmallestVoiValue('set', 0);
    machineLearningPSMAGa68FastSegmentation('set', false);

    % Ga68DOTATATE segmentation

    Ga68DOTATATESegmentationBoneMaskThresholdValue('set', 200); % HU
%     Ga68DOTATATESegmentationBoundaryPercentValue('set', 10);
    Ga68DOTATATENormalLiverSDValue  ('set', 0.4);
    Ga68DOTATATENormalLiverMeanValue('set', 4);
    Ga68DOTATATESmalestVoiValue     ('set', 0.3);


    % Machine Learning Ga68 DOTATATE segmentation Other Organ
    % Exclusion

    excludeGa68DOTATATEBrain            ('set', true );
    excludeGa68DOTATATETrachea          ('set', true );
    excludeGa68DOTATATEAdrenalGlandLeft ('set', true );
    excludeGa68DOTATATEAdrenalGlandRight('set', true );
    excludeGa68DOTATATEGallbladder      ('set', true );
    excludeGa68DOTATATEPancreas         ('set', false);
    excludeGa68DOTATATEKidneyLeft       ('set', true );
    excludeGa68DOTATATEKidneyRight      ('set', true );
    excludeGa68DOTATATESpleen           ('set', true );

    % Machine Learning Ga68 DOTATATE segmentation Gastrointestinal Tract
    % Exclusion

    excludeGa68DOTATATEUrinaryBladder('set', true );
    excludeGa68DOTATATEColon         ('set', false);
    excludeGa68DOTATATESmallBowel    ('set', false);
    excludeGa68DOTATATEDuodenum      ('set', false);
    excludeGa68DOTATATEStomach       ('set', false);
    excludeGa68DOTATATEEsophagus     ('set', false);

    % Machine Learning Ga68 DOTATATE Options

    Ga68DOTATATESmalestVoiValue('set', 0.3);

    Ga68DOTATATENormalLiverThresholdMultiplierValue('set', 1.5);


    % Machine Learning Full AI Ga68 DOTATATE Options

    Ga68DOTATATEFullAITrainedModel          ('set', 1);
    Ga68DOTATATEFullAISmalestVoiValue       ('set', 0);
    Ga68DOTATATEFullAILesionClassification  ('set', true);
    Ga68DOTATATEFullAISmoothMask            ('set', true);
    Ga68DOTATATEFullAIEnhancedBoneMaskLesion('set', false);

    % Voxel Dosimetry

    voxelDosimetryRadionuclide('set', 'Y-90');

    voxelDosimetryAlphaPhysicalModel                ('set', 3); % Monte Carlo
    voxelDosimetryBetaPhysicalModel                 ('set', 3); % Monte Carlo
    voxelDosimetryGammaPhysicalModel                ('set', 3); % Monte Carlo
    voxelDosimetryMonoenergeticElectronPhysicalModel('set', 3); % Monte Carlo
    voxelDosimetryPositronPhysicalModel             ('set', 3); % Monte Carlo
    voxelDosimetryXrayPhysicalModel                 ('set', 3); % Monte Carlo

    voxelDosimetryAlphaSourceParticles                ('set', 500000);
    voxelDosimetryBetaSourceParticles                 ('set', 500000);
    voxelDosimetryGammaSourceParticles                ('set', 500000);
    voxelDosimetryMonoenergeticElectronSourceParticles('set', 500000);
    voxelDosimetryPositronSourceParticles             ('set', 500000);
    voxelDosimetryXraySourceParticles                 ('set', 500000);

    voxelDosimetryAlphaSourceParticlesBatches                ('set', 10);
    voxelDosimetryBetaSourceParticlesBatches                 ('set', 10);
    voxelDosimetryGammaSourceParticlesBatches                ('set', 10);
    voxelDosimetryMonoenergeticElectronSourceParticlesBatches('set', 10);
    voxelDosimetryPositronSourceParticlesBatches             ('set', 10);
    voxelDosimetryXraySourceParticlesBatches                 ('set', 10);

    voxelDosimetryAlphaCutoff                ('set', 10); % In mm
    voxelDosimetryBetaCutoff                 ('set', 10); % In mm
    voxelDosimetryGammaCutoff                ('set', 10); % In mm
    voxelDosimetryMonoenergeticElectronCutoff('set', 10); % In mm
    voxelDosimetryPositronCutoff             ('set', 10); % In mm
    voxelDosimetryXrayCutoff                 ('set', 10); % In mm

    voxelDosimetryMachineLearningTissueDependant('set', true);
    voxelDosimetryTissueDependantBackground('set', 1); % Water
    voxelDosimetryPHITSDebugWindow('set', true);
    voxelDosimetryAllContours('set', false);

    machineLearningCTAnonymizationAnonymizationModule('set', 'face');
    machineLearningCTAnonymizationAnonymizationTechnique('set', 'gauss filter');
    machineLearningCTAnonymizationAssociatedSeries('set', true);

    clearDisplay();

    uiTopToolbar = ...
        uipanel(fiMainWindowPtr('get'),...
                'Units'   , 'pixels',...
                'Position', [0 ...
                             getMainWindowSize('ysize')-viewerToolbarHeight('get') ...
                             getMainWindowSize('xsize') ...
                             viewerToolbarHeight('get') ...
                             ],...
                'AutoResizeChildren', 'off', ...
                'HitTest', 'off', ...
                'BackgroundColor', viewerTopBarColor('get'), ...
                'ForegroundColor', viewerForegroundColor('get') ...
               );
     uiTopToolbarPtr('set', uiTopToolbar);

    uiTopWindow = ...
        uipanel(fiMainWindowPtr('get'),...
                'Units'   , 'pixels',...
                'Position', [0 ...
                             getMainWindowSize('ysize')-viewerTopBarHeight('get')-viewerToolbarHeight('get') ...
                             getMainWindowSize('xsize') ...
                             viewerTopBarHeight('get') ...
                             ],...
                'AutoResizeChildren', 'off', ...
                'HitTest', 'off', ...
                'BackgroundColor', viewerTopBarColor('get'), ...
                'ForegroundColor', viewerForegroundColor('get') ...
               );
     uiTopWindowPtr('set', uiTopWindow);

    % Segmentation Panel

     uiSegMainPanel = ...
        uipanel(fiMainWindowPtr('get'),...
                'Units'   , 'pixels',...
                'Position', [0 ...
                             addOnWidth('get')+30 ...
                            300 ...
                            getMainWindowSize('ysize')-viewerToolbarHeight('get')-viewerTopBarHeight('get')-addOnWidth('get')-30 ...
                            ],...
                'AutoResizeChildren', 'off', ...
                'Visible', 'off',...
                'HitTest', 'off', ...
                'BackgroundColor', viewerBackgroundColor ('get'), ...
                'ForegroundColor', viewerForegroundColor('get') ...
                );
     uiSegMainPanelPtr('set', uiSegMainPanel);

     uiSegPanel = ...
         uipanel(uiSegMainPanelPtr('get'),...
                 'Units'   , 'pixels',...
                 'Position', [0 ...
                              0 ...
                              280 ...
                              2000 ...
                              ],...
                'AutoResizeChildren', 'off', ...
                'Visible', 'off', ...
                'HitTest', 'off', ...
                'BackgroundColor', viewerBackgroundColor ('get'), ...
                'ForegroundColor', viewerForegroundColor('get') ...
                );
    uiSegPanelPtr('set', uiSegPanel);

    aSegMainPanelPosition = get(uiSegMainPanelPtr('get'), 'Position');
    uiSegPanelSlider = ...
        uicontrol('Style'   , 'Slider', ...
                  'Parent'  , uiSegMainPanelPtr('get'),...
                  'Units'   , 'pixels',...
                  'Position', [280 ...
                               0 ...
                               20 ...
                               aSegMainPanelPosition(4) ...
                               ],...
                  'Value', 0, ...
                  'Callback',@uiSegPanelSliderCallback, ...
                  'BackgroundColor', viewerBackgroundColor ('get'), ...
                  'ForegroundColor', viewerForegroundColor('get') ...
                  );
    uiSegPanelSliderPtr('set', uiSegPanelSlider);
    % addlistener(uiSegPanelSlider, 'Value', 'PreSet', @uiSegPanelSliderCallback);
    addlistener(uiSegPanelSlider, 'ContinuousValueChange', @uiSegPanelSliderCallback);

    initSegPanel();

    % Kernel Panel

    uiKernelMainPanel = ...
        uipanel(fiMainWindowPtr('get'),...
                'Units'   , 'pixels',...
                'Position', [0 ...
                             addOnWidth('get')+30 ...
                             300 ...
                             getMainWindowSize('ysize')-viewerToolbarHeight('get')-viewerTopBarHeight('get')-addOnWidth('get')-30 ...
                             ],...
                'AutoResizeChildren', 'off', ...
                'Visible', 'off',...
                'HitTest', 'off', ...
                'BackgroundColor', viewerBackgroundColor ('get'), ...
                'ForegroundColor', viewerForegroundColor('get') ...
                );
    uiKernelMainPanelPtr('set', uiKernelMainPanel);

    uiKernelPanel = ...
        uipanel(uiKernelMainPanelPtr('get'),...
                'Units'   , 'pixels',...
                'Position', [0 ...
                             0 ...
                             280 ...
                             2000 ...
                             ],...
                'AutoResizeChildren', 'off', ...
                'Visible', 'off', ...
                'HitTest', 'off', ...
                'BackgroundColor', viewerBackgroundColor ('get'), ...
                'ForegroundColor', viewerForegroundColor('get') ...
                );
    uiKernelPanelPtr('set', uiKernelPanel);

    aKernelMainPanelPosition = get(uiKernelMainPanelPtr('get'), 'Position');
    uiKernelPanelSlider = ...
        uicontrol('Style'   , 'Slider', ...
                  'Parent'  , uiKernelMainPanelPtr('get'),...
                  'Units'   , 'pixels',...
                  'Position', [280 ...
                               0 ...
                               20 ...
                               aKernelMainPanelPosition(4) ...
                               ],...
                  'Value'   , 0, ...
                  'Callback',@uiKernelPanelSliderCallback, ...
                  'BackgroundColor', viewerBackgroundColor ('get'), ...
                  'ForegroundColor', viewerForegroundColor('get') ...
                  );
    uiKernelPanelSliderPtr('set', uiKernelPanelSlider);
    % addlistener(uiKernelPanelSlider, 'Value', 'PreSet', @uiKernelPanelSliderCallback);
    addlistener(uiKernelPanelSlider, 'ContinuousValueChange', @uiKernelPanelSliderCallback);

    initKernelPanel();

    % Roi Panel

    uiRoiMainPanel = ...
        uipanel(fiMainWindowPtr('get'),...
                'Units'   , 'pixels',...
                'Position', [0 ...
                             addOnWidth('get')+30 ...
                             300 ...
                             getMainWindowSize('ysize')-viewerToolbarHeight('get')-viewerTopBarHeight('get')-addOnWidth('get')-30 ...
                             ],...
                'AutoResizeChildren', 'off', ...
                'Visible', 'off',...
                'HitTest', 'off', ...
                'BackgroundColor', viewerBackgroundColor ('get'), ...
                'ForegroundColor', viewerForegroundColor('get') ...
                );
    uiRoiMainPanelPtr('set', uiRoiMainPanel);

    uiRoiPanel = ...
        uipanel(uiRoiMainPanelPtr('get'),...
                'Units'   , 'pixels',...
                'Position', [0 ...
                             0 ...
                             280 ...
                             2000 ...
                             ],...
                'AutoResizeChildren', 'off', ...
                'HitTest', 'off', ...
                'Visible', 'off', ...
                'BackgroundColor', viewerBackgroundColor ('get'), ...
                'ForegroundColor', viewerForegroundColor('get') ...
                );
    uiRoiPanelPtr('set', uiRoiPanel);

    aRoiMainPanelPosition = get(uiRoiMainPanelPtr('get'), 'Position');
    uiRoiPanelSlider = ...
        uicontrol('Style'   , 'Slider', ...
                  'Parent'  , uiRoiMainPanelPtr('get'),...
                  'Units'   , 'pixels',...
                  'Position', [280 ...
                               0 ...
                               20 ...
                               aRoiMainPanelPosition(4) ...
                               ],...
                  'Value'   , 0, ...
                  'Callback',@uiRoiPanelSliderCallback, ...
                  'BackgroundColor', viewerBackgroundColor ('get'), ...
                  'ForegroundColor', viewerForegroundColor('get') ...
                  );
    uiRoiPanelSliderPtr('set', uiRoiPanelSlider);
    % addlistener(uiRoiPanelSlider, 'Value', 'PreSet', @uiRoiPanelSliderCallback);
    addlistener(uiRoiPanelSlider, 'ContinuousValueChange', @uiRoiPanelSliderCallback);

    % aRoiMainPanelPosition = get(uiRoiMainPanelPtr('get'), 'Position');
    % uiRoiPanelSlider = ...
    %     viewerSlider(uiRoiMainPanelPtr('get'), ...
    %                  [260 ...
    %                  0 ...
    %                  40 ...
    %                  aRoiMainPanelPosition(4) ...
    %                  ],...
    %                  viewerBackgroundColor('get'), ...  % color
    %                  [0.8 0.8 0.8], ...
    %                  [0.5 0.5 0.5], ...
    %                  [0.2 0.2 0.2], ...
    %                  0, 1, ...                          % min, max
    %                  0, ...                           % initial
    %                  @uiRoiPanelSliderCallback, ...            % callback
    %                  0.2, ...                           % very faint track
    %                  0.6 ...                            % semi-opaque thumb
    %                  );
    %
    % uiRoiPanelSliderPtr('set', uiRoiPanelSlider);

    initRoiPanel();

    if size(dicomBuffer('get'), 3) == 1
        if switchTo3DMode('get')     == true || ...
           switchToIsoSurface('get') == true || ...
           switchToMIPMode('get')    == true

                if showBorder('get') == true
                    sBorderType = 'line';
                else
                    sBorderType = 'none';
                end

                uiOneWindow = ...
                    uipanel(fiMainWindowPtr('get'),...
                            'Units'   , 'pixels',...
                            'BorderType'     , sBorderType, ...
                            'BackgroundColor', surfaceColor('get', background3DOffset('get')),...
                            'AutoResizeChildren', 'off', ...
                            'Position', [680 ...
                                         addOnWidth('get')+30 ...
                                         getMainWindowSize('xsize')-680 ...
                                         getMainWindowSize('ysize')-viewerToolbarHeight('get')-viewerTopBarHeight('get')-addOnWidth('get')-30 ...
                                         ]...
                            );
                  uiOneWindowPtr('set', uiOneWindow);

                  uiMain3DPanel = ...
                      uipanel(fiMainWindowPtr('get'),...
                              'Units'   , 'pixels',...
                              'AutoResizeChildren', 'off', ...
                              'HitTest', 'off', ...
                              'Position', [0 ...
                                           addOnWidth('get')+30 ...
                                           680 ...
                                           getMainWindowSize('ysize')-viewerToolbarHeight('get')-viewerTopBarHeight('get')-addOnWidth('get')-30 ...
                                           ]...
                              );
                  uiMain3DPanelPtr('set', uiMain3DPanel);

                  ui3DPanel = ...
                      uipanel(uiMain3DPanelPtr('get'),...
                              'Units'   , 'pixels',...
                              'Position', [0 ...
                                           0 ...
                                           660 ...
                                           2000 ...
                                           ],...
                              'AutoResizeChildren', 'off', ...
                              'HitTest', 'off', ...
                              'BackgroundColor', viewerBackgroundColor ('get'), ...
                              'ForegroundColor', viewerForegroundColor('get') ...
                              );
                   ui3DPanelPtr('set', ui3DPanel);

                  aMain3DPanelPosition = get(uiMain3DPanelPtr('get'), 'Position');
                  ui3DPanelSlider = ...
                      uicontrol('Style'   , 'Slider', ...
                                'Parent'  , uiMain3DPanelPtr('get'),...
                                'Units'   , 'pixels',...
                                'Position', [660 ...
                                             0 ...
                                             20 ...
                                             aMain3DPanelPosition(4) ...
                                             ],...
                                'Value', 0, ...
                                'Callback', @ui3DPanelSliderCallback, ...
                                'BackgroundColor', viewerBackgroundColor ('get'), ...
                                'ForegroundColor', viewerForegroundColor('get') ...
                                );
                  ui3DPanelSliderPtr('set', ui3DPanelSlider);
                  % addlistener(ui3DPanelSlider,'Value','PreSet', @ui3DPanelSliderCallback);
                  addlistener(ui3DPanelSlider, 'ContinuousValueChange', @ui3DPanelSliderCallback);
        else

            if showBorder('get') == true
                sBorderType = 'line';
            else
                sBorderType = 'none';
            end

            uiOneWindow = ...
                uipanel(fiMainWindowPtr('get'),...
                        'Units'          , 'pixels',...
                        'BorderType'     , sBorderType, ...
                        'BackgroundColor', backgroundColor('get'),...
                        'AutoResizeChildren', 'off', ...
                        'Position'       , [0 ...
                                            addOnWidth('get')+30 ...
                                            getMainWindowSize('xsize') ...
                                            getMainWindowSize('ysize')-viewerToolbarHeight('get')-viewerTopBarHeight('get')-addOnWidth('get')-30 ...
                                            ]...
                        );

            uiOneWindowPtr('set', uiOneWindow);

        end
    else
        aImageSize = size(dicomBuffer('get'));

        if showBorder('get') == true
            sBorderType = 'line';
        else
            sBorderType = 'none';
        end

        uiCorWindow = ...
            uipanel(fiMainWindowPtr('get'),...
                    'Units'          , 'pixels',...
                    'BorderType'     , sBorderType, ...
                    'BackgroundColor', backgroundColor('get'),...
                    'AutoResizeChildren', 'off', ...
                    'Position'       , [0 ...
                                        addOnWidth('get')+30 ...
                                        getMainWindowSize('xsize')/5 ...
                                        getMainWindowSize('ysize')-viewerToolbarHeight('get')-viewerTopBarHeight('get')-addOnWidth('get')-30-15 ...
                                        ]...
                    );
        uiCorWindowPtr('set', uiCorWindow);

        if isVsplash('get') == false

            aImgFullScreenIcon = getFullScreenIconImage(uiCorWindow, true);

            if ~isempty(aImgFullScreenIcon)

                aUiCorPosition = get(uiCorWindow ,'Position');

                btnUiCorWindowFullScreen = ...
                    uicontrol(uiCorWindow, ...
                             'Position'       , [aUiCorPosition(3)-20 10 20 20], ...
                             'Enable'         , 'on', ...
                             'String'         , '',...
                             'BackgroundColor', backgroundColor('get'), ...
                             'ForegroundColor', overlayColor('get'), ...
                             'TooltipString'  , 'Full Screen (Ctrl + F)', ...
                             'HitTest'        , 'off', ...
                             'CData'          , aImgFullScreenIcon, ...
                             'CallBack'       , @btnUiCorWindowFullScreenCallback ...
                             );
                btnUiCorWindowFullScreenPtr('set', btnUiCorWindowFullScreen);
            else
                btnUiCorWindowFullScreenPtr('set', []);
            end

            if strcmpi(default2DPlaybackPlane('get'), 'coronal')

                bValue = true;
            else
                bValue = false;
            end

            chkUiCorWindowSelected = ...
                uicontrol(uiCorWindow,...
                          'style'   , 'checkbox',...
                          'enable'  , 'on',...
                          'value'   , bValue,...
                          'position', [aUiCorPosition(3)-40 10 20 20],...
                          'BackgroundColor', backgroundColor('get'), ...
                          'ForegroundColor', overlayColor('get'), ...
                          'TooltipString'  , 'Coronal Playback', ...
                          'CallBack'       , @chkUiCorWindowSelectedCallback ...
                         );
            chkUiCorWindowSelectedPtr('set', chkUiCorWindowSelected);
        end

        % uiSliderCor = ...
        %       uicontrol(fiMainWindowPtr('get'), ...
        %                 'Style'   , 'Slider', ...
        %                 'Position', [0 ...
        %                              addOnWidth('get')+30 ...
        %                              getMainWindowSize('xsize')/5 ...
        %                              20 ...
        %                              ], ...
        %                 'Value'   , 0.5, ...
        %                 'Enable'  , 'on', ...
        %                 'CallBack', @sliderCorCallback, ...
        %                 'BackgroundColor', viewerBackgroundColor ('get'), ...
        %                 'ForegroundColor', viewerForegroundColor('get') ...
        %                 );

        uiSliderCor = ...
            viewerSlider(fiMainWindowPtr('get'), ...
                         [0 ...
                          addOnWidth('get')+30 ...
                          getMainWindowSize('xsize')/5 ...
                          20 ...
                         ], ...
                         viewerBackgroundColor('get'), ...  % color
                         [0.8 0.8 0.8], ...
                         [0.5 0.5 0.5], ...
                         [0.2 0.2 0.2], ...
                         0, 1, ...                          % min, max
                         0.5, ...                           % initial
                         @sliderCorCallback, ...            % callback
                         true, ...                          % In motion callback
                         0.2, ...                           % very faint track
                         0.6 ...                            % semi-opaque thumb
                         );

          uiSliderCorPtr('set', uiSliderCor);

          oldVal = get(uiSliderCor, 'Value');
          newVal = round(oldVal * aImageSize(1)) + 1;
          set(uiSliderCor, 'Min', 1, 'Max', aImageSize(1), ...
                           'SliderStep', [1/aImageSize(1) 1/aImageSize(1)], ...
                           'Value', newVal);

          % addlistener(uiSliderCor, 'Value', 'PreSet', @sliderCorCallback);
          % addlistener(uiSliderCor, 'ContinuousValueChange', @sliderCorCallback);

          uiSagWindow = ...
              uipanel(fiMainWindowPtr('get'),...
                      'Units'          , 'pixels',...
                      'BorderType'     , sBorderType, ...
                      'AutoResizeChildren', 'off', ...
                      'BackgroundColor', backgroundColor('get'),...
                      'Position', [getMainWindowSize('xsize')/5 ...
                                   addOnWidth('get')+30+15 ...
                                   getMainWindowSize('xsize')/5 ...
                                   getMainWindowSize('ysize')-viewerToolbarHeight('get')-viewerTopBarHeight('get')-addOnWidth('get')-30-15 ...
                                   ]...
                      );

        uiSagWindowPtr('set', uiSagWindow);

        if isVsplash('get') == false

            aImgFullScreenIcon = getFullScreenIconImage(uiSagWindow, true);

            if ~isempty(aImgFullScreenIcon)

                aUiSagPosition = get(uiSagWindow ,'Position');

                btnUiSagWindowFullScreen = ...
                    uicontrol(uiSagWindow, ...
                             'Position'       , [aUiSagPosition(3)-20 10 20 20], ...
                             'Enable'         , 'on', ...
                             'String'         , '',...
                             'BackgroundColor', backgroundColor('get'), ...
                             'ForegroundColor', overlayColor('get'), ...
                             'TooltipString'  , 'Full Screen (Ctrl + F)', ...
                             'HitTest'        , 'off', ...
                             'CData'          , aImgFullScreenIcon, ...
                             'CallBack'       , @btnUiSagWindowFullScreenCallback ...
                             );
                btnUiSagWindowFullScreenPtr('set', btnUiSagWindowFullScreen);
            else
                btnUiSagWindowFullScreenPtr('set', []);
            end

            if strcmpi(default2DPlaybackPlane('get'), 'sagittal')

                bValue = true;
            else
                bValue = false;
            end

            chkUiSagWindowSelected = ...
                uicontrol(uiSagWindow,...
                          'style'   , 'checkbox',...
                          'enable'  , 'on',...
                          'value'   , bValue,...
                          'position', [aUiSagPosition(3)-40 10 20 20],...
                          'BackgroundColor', backgroundColor('get'), ...
                          'ForegroundColor', overlayColor('get'), ...
                          'TooltipString'  , 'Sagittal Playback', ...
                          'CallBack'       , @chkUiSagWindowSelectedCallback ...
                          );
            chkUiSagWindowSelectedPtr('set', chkUiSagWindowSelected);

        end

         % uiSliderSag = ...
         %     uicontrol(fiMainWindowPtr('get'), ...
         %               'Style'   , 'Slider', ...
         %               'Position', [(getMainWindowSize('xsize')/5) ...
         %                            addOnWidth('get')+30 ...
         %                            getMainWindowSize('xsize')/5 ...
         %                            20 ...
         %                            ], ...
         %               'Value'   , 0.5, ...
         %               'Enable'  , 'on', ...
         %               'CallBack', @sliderSagCallback, ...
         %               'BackgroundColor', viewerBackgroundColor ('get'), ...
         %               'ForegroundColor', viewerForegroundColor('get') ...
         %               );
         % uiSliderSagPtr('set', uiSliderSag);

        uiSliderSag = ...
            viewerSlider(fiMainWindowPtr('get'), ...
                         [(getMainWindowSize('xsize')/5) ...
                          addOnWidth('get')+30 ...
                          getMainWindowSize('xsize')/5 ...
                          20 ...
                         ], ...
                         viewerBackgroundColor('get'), ...  % color
                         [0.8 0.8 0.8], ...
                         [0.5 0.5 0.5], ...
                         [0.2 0.2 0.2], ...
                         0, 1, ...                          % min, max
                         0.5, ...                           % initial
                         @sliderSagCallback, ...            % callback
                         true, ...                          % In motion callback
                         0.2, ...                           % very faint track
                         0.6 ...                            % semi-opaque thumb
                         );

        uiSliderSagPtr('set', uiSliderSag);

         oldVal = get(uiSliderSag, 'Value');
         newVal = round(oldVal * aImageSize(2)) + 1;
         set(uiSliderSag, 'Min', 1, 'Max', aImageSize(2), ...
                          'SliderStep', [1/aImageSize(2) 1/aImageSize(2)], ...
                          'Value', newVal);

         % addlistener(uiSliderSag,'Value','PreSet',@sliderSagCallback);
         % addlistener(uiSliderSag, 'ContinuousValueChange', @sliderSagCallback);

         uiTraWindow = ...
             uipanel(fiMainWindowPtr('get'),...
                     'Units'          , 'pixels',...
                     'BorderType'     , sBorderType, ...
                     'AutoResizeChildren', 'off', ...
                     'BackgroundColor', backgroundColor('get'),...
                     'Position'       , [(getMainWindowSize('xsize')/2.5) ...
                                         addOnWidth('get')+30+15 ...
                                         getMainWindowSize('xsize')/2.5 ...
                                         getMainWindowSize('ysize')-viewerToolbarHeight('get')-viewerTopBarHeight('get')-addOnWidth('get')-30-15 ...
                                         ]...
                     );
        uiTraWindowPtr('set', uiTraWindow);

        if isVsplash('get') == false

            aImgFullScreenIcon = getFullScreenIconImage(uiTraWindow, true);

            if ~isempty(aImgFullScreenIcon)

                aUiTraPosition = get(uiTraWindow ,'Position');

                btnUiTraWindowFullScreen = ...
                    uicontrol(uiTraWindow, ...
                             'Position'       , [aUiTraPosition(3)-73 10 20 20], ...
                             'Enable'         , 'on', ...
                             'String'         , '',...
                             'BackgroundColor', backgroundColor('get'), ...
                             'ForegroundColor', overlayColor('get'), ...
                             'TooltipString'  , 'Full Screen (Ctrl + F)', ...
                             'HitTest'        , 'off', ...
                             'CData'          , aImgFullScreenIcon, ...
                             'CallBack'       , @btnUiTraWindowFullScreenCallback ...
                             );
                btnUiTraWindowFullScreenPtr('set', btnUiTraWindowFullScreen);
            else
                btnUiTraWindowFullScreenPtr('set', []);
            end

            if strcmpi(default2DPlaybackPlane('get'), 'axial')

                bValue = true;
            else
                bValue = false;
            end

            chkUiTraWindowSelected = ...
                uicontrol(uiTraWindow,...
                          'style'   , 'checkbox',...
                          'enable'  , 'on',...
                          'value'   , bValue,...
                          'position', [aUiTraPosition(3)-93 10 20 20],...
                          'BackgroundColor', backgroundColor('get'), ...
                          'ForegroundColor', overlayColor('get'), ...
                          'TooltipString'  , 'Axial Playback', ...
                          'CallBack'       , @chkUiTraWindowSelectedCallback ...
                          );
            chkUiTraWindowSelectedPtr('set', chkUiTraWindowSelected);

        end

        % uiSliderTra = ...
        %     uicontrol(fiMainWindowPtr('get'), ...
        %               'Style'   , 'Slider', ...
        %               'Position', [(getMainWindowSize('xsize')/2.5) ...
        %                            addOnWidth('get')+30 ...
        %                            getMainWindowSize('xsize')/2.5 ...
        %                            20 ...
        %                            ], ...
        %               'Value'   , 0.5, ...
        %               'Enable'  , 'on', ...
        %               'CallBack', @sliderTraCallback, ...
        %               'BackgroundColor', viewerBackgroundColor ('get'), ...
        %               'ForegroundColor', viewerForegroundColor('get') ...
        %               );
        % uiSliderTraPtr('set', uiSliderTra);
        uiSliderTra = ...
            viewerSlider(fiMainWindowPtr('get'), ...
                         [(getMainWindowSize('xsize')/2.5) ...
                          addOnWidth('get')+30 ...
                          getMainWindowSize('xsize')/2.5 ...
                          20 ...
                         ], ...
                         viewerBackgroundColor('get'), ...  % color
                         [0.8 0.8 0.8], ...
                         [0.5 0.5 0.5], ...
                         [0.2 0.2 0.2], ...
                         0, 1, ...                          % min, max
                         0.5, ...                           % initial
                         @sliderTraCallback, ...            % callback
                         true, ...                          % In motion callback
                         0.2, ...                           % very faint track
                         0.6 ...                            % semi-opaque thumb
                         );
        uiSliderTraPtr('set', uiSliderTra);

        oldVal = get(uiSliderTra, 'Value');
        newVal = round(oldVal * aImageSize(3)) + 1;
        set(uiSliderTra, 'Min', 1, 'Max', aImageSize(3), ...
                         'SliderStep', [1/aImageSize(3) 1/aImageSize(3)], ...
                         'Value', newVal);

        % addlistener(uiSliderTra, 'Value', 'PreSet', @sliderTraCallback);
        % addlistener(uiSliderTra, 'ContinuousValueChange', @sliderTraCallback);

         uiMipWindow = ...
             uipanel(fiMainWindowPtr('get'),...
                     'Units'          , 'pixels',...
                     'BorderType'     , sBorderType, ...
                     'BackgroundColor', backgroundColor('get'),...
                     'AutoResizeChildren', 'off', ...
                     'Position'       , [(getMainWindowSize('xsize')/1.25) ...
                                         addOnWidth('get')+30+15 ...
                                         getMainWindowSize('xsize')/5 ...
                                         getMainWindowSize('ysize')-viewerToolbarHeight('get')-viewerTopBarHeight('get')-addOnWidth('get')-30-15 ...
                                         ]...
                     );
        uiMipWindowPtr('set', uiMipWindow);

        if isVsplash('get') == false

            aImgFullScreenIcon = getFullScreenIconImage(uiMipWindow, true);

            if ~isempty(aImgFullScreenIcon)

                aUiMipPosition = get(uiMipWindow ,'Position');

                btnUiMipWindowFullScreen = ...
                    uicontrol(uiMipWindow, ...
                             'Position'       , [aUiMipPosition(3)-20 10 20 20], ...
                             'Enable'         , 'on', ...
                             'String'         , '',...
                             'BackgroundColor', backgroundColor('get'), ...
                             'ForegroundColor', overlayColor('get'), ...
                             'TooltipString'  , 'Full Screen (Ctrl + F)', ...
                             'HitTest'        , 'off', ...
                             'CData'          , aImgFullScreenIcon, ...
                             'CallBack'       , @btnUiMipWindowFullScreenCallback ...
                             );
                btnUiMipWindowFullScreenPtr('set', btnUiMipWindowFullScreen);
            else
                btnUiMipWindowFullScreenPtr('set', []);
            end

            if strcmpi(default2DPlaybackPlane('get'), 'mip')

                bValue = true;
            else
                bValue = false;
            end

            chkUiMipWindowSelected = ...
                uicontrol(uiMipWindow,...
                          'style'   , 'checkbox',...
                          'enable'  , 'on',...
                          'value'   , bValue,...
                          'position', [aUiMipPosition(3)-40 10 20 20],...
                          'BackgroundColor', backgroundColor('get'), ...
                          'ForegroundColor', overlayColor('get'), ...
                          'TooltipString'  , 'MIP Playback', ...
                          'CallBack'       , @chkUiMipWindowSelectedCallback ...
                          );
            chkUiMipWindowSelectedPtr('set', chkUiMipWindowSelected);

        end

        if mipAngle('get') == 1
            dMipSliderValue = 0;
        else
            dMipSliderValue = mipAngle('get')/32;
        end

        % uiSliderMip = ...
        %     uicontrol(fiMainWindowPtr('get'), ...
        %               'Style'   , 'Slider', ...
        %               'Position', [(getMainWindowSize('xsize')/1.25) ...
        %                            addOnWidth('get')+30 ...
        %                            getMainWindowSize('xsize')/5 ...
        %                            20 ...
        %                            ], ...
        %               'Value'   ,  dMipSliderValue, ...
        %               'Enable'  , 'on', ...
        %               'CallBack', @sliderTraCallback, ...
        %               'BackgroundColor', viewerBackgroundColor ('get'), ...
        %               'ForegroundColor', viewerForegroundColor('get') ...
        %               );

        uiSliderMip = ...
            viewerSlider(fiMainWindowPtr('get'), ...
                         [(getMainWindowSize('xsize')/1.25) ...
                          addOnWidth('get')+30 ...
                          getMainWindowSize('xsize')/5 ...
                          20 ...
                         ], ...
                         viewerBackgroundColor('get'), ...  % color
                         [0.8 0.8 0.8], ...
                         [0.5 0.5 0.5], ...
                         [0.2 0.2 0.2], ...
                         0, 1, ...                          % min, max
                         dMipSliderValue, ...               % initial
                         @sliderMipCallback, ...            % callback
                         true, ...                          % In motion callback
                         0.2, ...                           % very faint track
                         0.6 ...                            % semi-opaque thumb
                         );

        uiSliderMipPtr('set', uiSliderMip);

        oldVal = get(uiSliderMip, 'Value');      % e.g., 0.5 in [0, 1]
        newVal = round(oldVal * 31) + 1;         % maps 01 to 132
        set(uiSliderMip, 'Min', 1, 'Max', 32, ...
                         'SliderStep', [1/31 1/31], ...
                         'Value', newVal);

        % addlistener(uiSliderMip, 'Value', 'PreSet', @sliderMipCallback);
        % addlistener(uiSliderMip, 'ContinuousValueChange', @sliderMipCallback);

    end

    %        uiAddOnWindow =  uipanel(fiMainWindowPtr('get'),...
    %                              'Units'   , 'pixels',...
    %                              'Position', [0 ...
    %                                           30 ...
    %                                           getMainWindowSize('xsize') ...
    %                                           addOnWidth('get')]...
    %                               );

     mainWindowMenu();

     if numel(inputTemplate('get'))
        sSeriesEnable = 'on';
     else
        sSeriesEnable = 'off';
     end

     uiSeries = ...
        uicontrol(uiTopWindowPtr('get'), ...
                  'Style'   , 'listbox', ...
                  'Position', [5 5 292 50], ...  % This WILL respect the height!
                  'Enable'  , sSeriesEnable, ...
                  'String'  , seriesDescription('get'), ...
                  'Value'   , 1, ...
                  'Max'     , 1, ...
                  'Min'     , 0, ...
                  'Callback', @setSeriesCallback, ...
                  'BackgroundColor', viewerBackgroundColor('get'), ...
                  'ForegroundColor', viewerForegroundColor('get'), ...
                  'Tooltip', 'Series selector');
     uiSeriesPtr('set', uiSeries);

     if ~isMATLABReleaseOlderThan('R2025a') || viewerUIFigure('get') == true
        sTooltipText = '3D Volume rendering: Click to enable 3D view, click again to revert to 2D view.';
     else
        sTooltipText = '<html>3D Volume rendering<br>Click to enable 3D view, click again to revert to 2D view</html>';
     end

     btn3D = uicontrol(uiTopWindowPtr('get'),...
                      'Position', [300 5 viewerTopBarIconSize('get') viewerTopBarIconSize('get')],...
                      'Enable'  , 'off', ...
                      'CData'   , resizeTopBarIcon('3d_volume_grey.png'), ...
                      'Callback', @set3DCallback, ...
                      'BackgroundColor', viewerBackgroundColor ('get'), ...
                      'ForegroundColor', viewerForegroundColor('get'), ...
                      'HitTest', 'off', ...
                      'Tooltip', sTooltipText...
                     );
 
     btn3DPtr('set', btn3D);

    if ~isMATLABReleaseOlderThan('R2025a') || viewerUIFigure('get') == true
        sTooltipText = '3D ISOsurface: Click to enable 3D view, click again to revert to 2D view.';
    else
        sTooltipText = '<html>3D ISOsurface<br>Click to enable 3D view, click again to revert to 2D view</html>';
    end

    btnIsoSurface = uicontrol(uiTopWindowPtr('get'),...
                              'Position', [355 5 viewerTopBarIconSize('get') viewerTopBarIconSize('get')],...
                              'Enable'  , 'off', ...
                              'CData'   , resizeTopBarIcon('3d_iso_grey.png'), ...
                              'Callback', @setIsoSurfaceCallback, ...
                              'BackgroundColor', viewerBackgroundColor ('get'), ...
                              'ForegroundColor', viewerForegroundColor('get'), ...
                              'HitTest', 'off', ...
                              'Tooltip', sTooltipText...
                             );
    btnIsoSurfacePtr('set', btnIsoSurface);

    if ~isMATLABReleaseOlderThan('R2025a') || viewerUIFigure('get') == true
        sTooltipText = '3D Maximum Intensity Projection: Click to enable 3D view, click again to revert to 2D view.';
    else
        sTooltipText = '<html>3D Maximum Intensity Projection<br>Click to enable 3D view, click again to revert to 2D view</html>';
    end

    btnMIP = uicontrol(uiTopWindowPtr('get'),...
                       'Position', [410 5 viewerTopBarIconSize('get') viewerTopBarIconSize('get')],...
                       'Enable'  , 'off', ...
                       'CData'   , resizeTopBarIcon('3d_mip_grey.png'), ...
                       'Callback', @setMIPCallback, ...
                       'BackgroundColor', viewerBackgroundColor ('get'), ...
                       'ForegroundColor', viewerForegroundColor('get'), ...
                       'HitTest', 'off', ...
                       'Tooltip', sTooltipText...
                      );
    btnMIPPtr('set', btnMIP);

    if numel(inputTemplate('get'))
        sBackgroundColor = viewerButtonPushedBackgroundColor('get');
        sForegroundColor = viewerButtonPushedForegroundColor('get');
        % sFontWeight = 'bold';
    else
        sBackgroundColor = viewerBackgroundColor('get');
        sForegroundColor = viewerForegroundColor('get');
        % sFontWeight = 'normal';
     end

    % Create button with icon
    btnTriangulate = ...
        uicontrol(uiTopWindowPtr('get'), ...
                  'Style'          , 'pushbutton', ...
                  'Position'       , [475 5 viewerTopBarIconSize('get') viewerTopBarIconSize('get')], ...   % Adjust size to icon dimensions
                  'Enable'         , 'off', ...
                  'CData'          , resizeTopBarIcon('triangulate_white.png'), ...
                  'Tooltip'        , 'Triangulation (T)', ...
                  'BackgroundColor', sBackgroundColor, ...
                  'ForegroundColor', sForegroundColor, ...
                  'HitTest'        , 'off', ...
                  'Callback'       , @triangulateCallback ...
                  );
     btnTriangulatePtr('set', btnTriangulate);

     if ~isMATLABReleaseOlderThan('R2025a') || viewerUIFigure('get') == true
        sTooltipText = 'Pan (N): Press ''N'' or click to enable, click again or right-click to return to triangulation.';
     else
        sTooltipText = '<html>Pan (N)<br>Press ''N'' or click to enable, click again or right-click to return to triangulation</html>';
     end

     btnPan = uicontrol(uiTopWindowPtr('get'), ...
                       'Position'       , [530 5 viewerTopBarIconSize('get') viewerTopBarIconSize('get')], ...
                       'Enable'         , 'off', ...
                       'CData'          , resizeTopBarIcon('pan_grey.png'), ...
                       'Callback'       , @setPanCallback, ...
                       'BackgroundColor', viewerBackgroundColor ('get'), ...
                       'ForegroundColor', viewerForegroundColor('get'), ...
                       'HitTest', 'off', ...
                       'Tooltip', sTooltipText...
                      );
     btnPanPtr('set', btnPan);

    if ~isMATLABReleaseOlderThan('R2025a') || viewerUIFigure('get') == true
        sTooltipText = 'Zoom (Z): Press ''Z'' or click to enable, click again or right-click to return to triangulation.';
    else
        sTooltipText = '<html>Zoom (Z)<br>Press ''Z'' or click to enable, click again or right-click to return to triangulation</html>';
    end

    btnZoom = uicontrol(uiTopWindowPtr('get'), ...
                        'Position', [585 5 viewerTopBarIconSize('get') viewerTopBarIconSize('get')], ...
                        'Enable'  , 'off', ...
                        'CData'   , resizeTopBarIcon('zoom_grey.png'), ...
                        'Callback', @setZoomCallback, ...
                        'BackgroundColor', viewerBackgroundColor ('get'), ...
                        'ForegroundColor', viewerForegroundColor('get'), ...
                        'HitTest', 'off', ...
                        'Tooltip', sTooltipText...
                       );
    btnZoomPtr('set', btnZoom);

    btnRegister = uicontrol(uiTopWindowPtr('get'), ...
                          'Position', [650 5 viewerTopBarIconSize('get') viewerTopBarIconSize('get')], ...
                          'Enable'  , 'off', ...
                          'CData'   , resizeTopBarIcon('register_grey.png'), ...
                          'Callback', @setRegistrationCallback, ...
                          'BackgroundColor', viewerBackgroundColor ('get'), ...
                          'ForegroundColor', viewerForegroundColor('get'), ...
                          'HitTest', 'off', ...
                          'Tooltip', 'Image Registration and resampling'...
                          );
    btnRegisterPtr('set', btnRegister);

    btnMath = uicontrol(uiTopWindowPtr('get'), ...
                          'Position', [705 5 viewerTopBarIconSize('get') viewerTopBarIconSize('get')], ...
                          'Enable'  , 'off', ...
                          'CData'   , resizeTopBarIcon('math_grey.png'), ...
                          'Callback', @setMathCallback, ...
                          'BackgroundColor', viewerBackgroundColor ('get'), ...
                          'ForegroundColor', viewerForegroundColor('get'), ...
                          'HitTest', 'off', ...
                          'Tooltip', 'Mathematical toolset'...
                          );
    btnMathPtr('set', btnMath);

    if ~isMATLABReleaseOlderThan('R2025a') || viewerUIFigure('get') == true
        sTooltipText = '2D montage of a 3D image: Change the view from the ''View'' menu. Click to enable the ''V-Splash'' view, click again to return to the previous view.';
    else
        sTooltipText = '<html>2D montage of a 3D image<br>Change the view from the ''View'' menu<br>Click to enable the ''V-Splash'' view, click again to return to the previous view</html>';
    end

    btnVsplash = uicontrol(uiTopWindowPtr('get'), ...
                           'Position', [760 5 viewerTopBarIconSize('get') viewerTopBarIconSize('get')], ...
                           'Enable'  , 'off', ...
                           'CData'   , resizeTopBarIcon('splash_grey.png'), ...
                           'Callback', @setVsplashCallback, ...
                           'BackgroundColor', viewerBackgroundColor ('get'), ...
                           'ForegroundColor', viewerForegroundColor('get'), ...
                           'HitTest', 'off', ...
                           'Tooltip', sTooltipText...
                          );
    btnVsplashPtr('set', btnVsplash);

    uiEditVsplahX = ...
        uicontrol(uiTopWindowPtr('get'), ...
                  'Style'   , 'Edit', ...
                  'Position', [815 5 25 24], ...
                  'String'  , num2str(vSplashLayout('get', 'x')), ...
                  'Enable'  , 'off', ...
                  'CallBack', @setVsplashLayoutCallback, ...
                  'BackgroundColor', viewerBackgroundColor ('get'), ...
                  'ForegroundColor', viewerForegroundColor('get'), ...
                  'HitTest', 'off', ...
                  'Tooltip', 'V-Splash: Number of Rows'...
               );
    uiEditVsplahXPtr('set', uiEditVsplahX);

    uiEditVsplahY = ...
        uicontrol(uiTopWindowPtr('get'), ...
                  'Style'   , 'Edit', ...
                  'Position', [815 32 25 24], ...
                  'String'  , num2str(vSplashLayout('get', 'y')), ...
                  'Enable'  , 'off', ...
                  'CallBack', @setVsplashLayoutCallback, ...
                  'BackgroundColor', viewerBackgroundColor ('get'), ...
                  'ForegroundColor', viewerForegroundColor('get'), ...
                  'HitTest', 'off', ...
                  'Tooltip', 'V-Splash: Number of Columns'...
                  );
    uiEditVsplahYPtr('set', uiEditVsplahY);

    if numel(seriesDescription('get')) > 1
        sFusionDescription = seriesDescription('get');
        dFusionValue       = 2;
    else
        if numel(dicomBuffer('get')) > 0
            sFusionDescription = seriesDescription('get');
            dFusionValue       = 1;
        else
            sFusionDescription = ' ';
            dFusionValue       = 1;
        end
    end

    if ~isMATLABReleaseOlderThan('R2025a') || viewerUIFigure('get') == true
        sTooltipText = 'Image Fusion: Click to activate/deactivate.';
    else
        sTooltipText = '<html>Image Fusion<br>Click to activate/deactivate</html>';
    end

    btnFusion = uicontrol(uiTopWindowPtr('get'), ...
                          'Position', [855 5 viewerTopBarIconSize('get') viewerTopBarIconSize('get')], ...
                          'Enable'  , 'off', ...
                          'CData'   , resizeTopBarIcon('fusion_grey.png'), ...
                          'Callback', @setFusionCallback, ...
                          'BackgroundColor', viewerBackgroundColor ('get'), ...
                          'ForegroundColor', viewerForegroundColor('get'), ...
                          'HitTest', 'off', ...
                          'Tooltip', sTooltipText...
                         );
    btnFusionPtr('set', btnFusion);

    if ~isMATLABReleaseOlderThan('R2025a') || viewerUIFigure('get') == true
        sTooltipText = 'Image Fusion Series Selector: When the fusion is activated, add another series to the current fusion by selecting it.';
    else
        sTooltipText = '<html>Image Fusion Series Selector<br>When the fusion is activated, add another series to the current fusion by selecting it</html>';
    end

    uiFusedSeries = uicontrol(uiTopWindowPtr('get'), ...
                              'Style'   , 'listbox', ...
                              'Position', [910 5 290 50], ...
                              'String'  , sFusionDescription, ...
                              'Value'   , dFusionValue,...
                              'Enable'  , 'off', ...
                              'Callback', @setFusionSeriesCallback, ...
                              'BackgroundColor', viewerBackgroundColor ('get'), ...
                              'ForegroundColor', viewerForegroundColor('get'), ...
                              'HitTest', 'off', ...
                              'Tooltip', sTooltipText...
                             );
    uiFusedSeriesPtr('set', uiFusedSeries);

    if ~isMATLABReleaseOlderThan('R2025a') || viewerUIFigure('get') == true
        sTooltipText = 'Link 2D MIP: When activated, the colormap, intensity, and fusion will synchronize.';
    else
        sTooltipText = '<html>Link 2D MIP<br>When activated, the colormap, intensity and fusion will synchronize</html>';
    end

    btnLinkMip = uicontrol(uiTopWindowPtr('get'), ...
                           'Position', [1210 5 viewerTopBarIconSize('get') viewerTopBarIconSize('get')], ...
                           'Enable'  , 'off', ...
                           'CData'   , resizeTopBarIcon('link_mip_grey.png'), ...
                           'Callback', @setLinkMipCallback, ...
                           'BackgroundColor', viewerBackgroundColor ('get'), ...
                           'ForegroundColor', viewerForegroundColor('get'), ...
                           'HitTest', 'off', ...
                           'Tooltip', sTooltipText...
                          );
    btnLinkMipPtr('set', btnLinkMip);

    if link2DMip('get') == true

        set(btnLinkMipPtr('get'), 'BackgroundColor', viewerButtonPushedBackgroundColor('get'));
        set(btnLinkMipPtr('get'), 'ForegroundColor', viewerButtonPushedForegroundColor('get'));

        set(btnLinkMipPtr('get'), 'CData', resizeTopBarIcon('link_mip_white.png'));
    else
        set(btnLinkMipPtr('get'), 'BackgroundColor', viewerBackgroundColor('get'));
        set(btnLinkMipPtr('get'), 'ForegroundColor', viewerForegroundColor('get'));

        set(btnLinkMipPtr('get'), 'CData', resizeTopBarIcon('link_mip_grey.png'));
    end
    
%     aScreenSize  = get(groot, 'Screensize');
%
%     if aScreenSize(3) > 1450
%         aTopWindowBarPosition = get(uiTopWindowPtr('get'), 'Position');
%         btnExitViewer = ...
%             uicontrol(uiTopWindowPtr('get'), ...
%                       'Position', [aTopWindowBarPosition(3)-70 6 65 25], ...
%                       'FontWeight','bold',...
%                       'Enable'  , 'on', ...
%                       'String'  , 'Exit',...
%                       'Callback', 'close', ...
%                       'BackgroundColor', [0.3255, 0.1137, 0.1137], ...
%                       'ForegroundColor', [0.94 0.94 0.94], ...
%                       'Tooltip', 'Exit Viewer'...
%                      );
%         btnExitViewerPtr('set', btnExitViewer);
%     end

    if size(dicomBuffer('get'), 3) == 1

        axef = ... % We need a toolbar for 3D visualisation
            axes(uiOneWindowPtr('get'), ...
                 'Units'   , 'normalized', ...
                 'Ydir'    , 'reverse', ...
                 'Position', [0 0 1 1], ...
                 'Box'     , 'off', ...
                 'Visible' , 'off'...
                 );
        axef.Interactions = [zoomInteraction regionZoomInteraction rulerPanInteraction];
        % axef.Toolbar.Visible = 'off';
        axefPtr('set', axef, 1);
        disableDefaultInteractivity(axef);
        deleteAxesToolbar(axef);

        axefc = ...
            axes(uiOneWindowPtr('get'), ...
                 'Units'   , 'normalized', ...
                 'Ydir'    , 'reverse', ...
                 'Position', [0 0 1 1], ...
                 'Box'     , 'off', ...
                 'Visible' , 'off'...
                 );
        axefc.Interactions = [zoomInteraction regionZoomInteraction rulerPanInteraction];
        % axefc.Toolbar.Visible = 'off';
        axefcPtr('set', axefc, 1);
        disableDefaultInteractivity(axefc);
        deleteAxesToolbar(axefc);

%        axer = ...
%            axes(uiOneWindowPtr('get'), ...
%                 'Units'   , 'normalized', ...
%                 'Ydir'    , 'reverse', ...
%                 'Position', [0 0 1 1], ...
%                 'Visible' , 'off'...
%                 );
%        axis(axer, 'equal');
%        axerPtr('set', axer, 1);
        axesColorbar = ...
            uiaxes(uiOneWindowPtr('get'), ...
                   'Units'   , 'pixels', ...
                   'Position', [0 0 1 1], ...
                   'Visible' , 'on', ...
                   'Ydir'    , 'normal', ...
                   'Tag'     , 'colorbar', ...
                   'Box'     , 'off', ...
                   'XLim'    , [0 inf], ...
                   'YLim'    , [0 inf], ...
                   'CLim'    , [0 inf] ...
                 );

        axesColorbar.Interactions = [];
        % axesColorbar.Toolbar.Visible = 'off';
        axesColorbarPtr('set', axesColorbar, get(uiSeriesPtr('get'), 'Value'));
        disableDefaultInteractivity(axesColorbar);
        deleteAxesToolbar(axesColorbar);

        axesFusionColorbar = ...
            uiaxes(uiOneWindowPtr('get'), ...
                   'Units'   , 'pixels', ...
                   'Position', [0 0 1 1], ...
                   'Visible' , 'on', ...
                   'Ydir'    , 'normal', ...
                   'Tag'     , 'fusion colorbar', ...
                   'Box'     , 'off', ...
                   'XLim'    , [0 inf], ...
                   'YLim'    , [0 inf], ...
                   'CLim'    , [0 inf] ...
                 );
        axesFusionColorbar.Interactions = [];
        % axesFusionColorbar.Toolbar.Visible = 'off';
        axesFusionColorbarPtr('set', axesFusionColorbar, get(uiSeriesPtr('get'), 'Value'));
        disableDefaultInteractivity(axesFusionColorbar);
        deleteAxesToolbar(axesFusionColorbar);

        axe = ...  % We need a toolbar for 3D visualisation
            axes(uiOneWindowPtr('get'), ...
                 'Units'   , 'normalized', ...
                 'Ydir'    , 'reverse', ...
                 'Position', [0 0 1 1], ...
                 'Box'     , 'off', ...
                 'Visible' , 'off'...
                 );
        axe.Interactions = [zoomInteraction regionZoomInteraction rulerPanInteraction];
        axe.Toolbar.Visible = 'off';
        axePtr('set', axe, 1);
        disableDefaultInteractivity(axe);

%        linkaxes([axe axer],'xy');
%        uistack(axer, 'top');
    else

       axes1f = ...
           axes(uiCorWindowPtr('get'), ...
                'Units'   , 'normalized', ...
                'Ydir'    , 'reverse', ...
                'xlimmode','manual',...
                'ylimmode','manual',...
                'zlimmode','manual',...
                'climmode','manual',...
                'alimmode','manual',...
                'Box'     , 'off', ...
                'Position', [0 0 1 1], ...
                'color','none',...
                'Visible' , 'off'...
                );
       axes1f.Interactions = [zoomInteraction regionZoomInteraction rulerPanInteraction];
       % axes1f.Toolbar.Visible = 'off';
       axes1fPtr('set', axes1f, 1);
       disableDefaultInteractivity(axes1f);
       deleteAxesToolbar(axes1f);

       axes1fc = ...
           axes(uiCorWindowPtr('get'), ...
                'Units'   , 'normalized', ...
                'Ydir'    , 'reverse', ...
                'xlimmode','manual',...
                'ylimmode','manual',...
                'zlimmode','manual',...
                'climmode','manual',...
                'alimmode','manual',...
                'Box'     , 'off', ...
                'Position', [0 0 1 1], ...
                'color','none',...
                'Visible' , 'off'...
                );
       axes1fc.Interactions = [zoomInteraction regionZoomInteraction rulerPanInteraction];
       % axes1fc.Toolbar.Visible = 'off';
       axes1fcPtr('set', axes1fc, 1);
       disableDefaultInteractivity(axes1fc);
       deleteAxesToolbar(axes1fc);

%       axes1r = ...
%           axes(uiCorWindowPtr('get'), ...
%                'Units'   , 'normalized', ...
%                'Ydir'    , 'reverse', ...
%                'xlimmode', 'manual',...
%                'ylimmode', 'manual',...
%                'zlimmode', 'manual',...
%                'climmode', 'manual',...
%                'alimmode', 'manual',...
%                'Position', [0 0 1 1], ...
%                'Visible' , 'off'...
%                );
%       axis(axes1r, 'equal');
%       axes1rPtr('set', axes1r, 1);

       axes1 = ...
           axes(uiCorWindowPtr('get'), ...
                'Units'   , 'normalized', ...
                'Ydir'    , 'reverse', ...
                'xlimmode', 'manual',...
                'ylimmode', 'manual',...
                'zlimmode', 'manual',...
                'climmode', 'manual',...
                'alimmode', 'manual',...
                'Box'     , 'off', ...
                'Position', [0 0 1 1], ...
                'Visible' , 'off'...
                );
       axes1.Interactions = [zoomInteraction regionZoomInteraction rulerPanInteraction];
       % axes1.Toolbar.Visible = 'off';
       axes1Ptr('set', axes1, 1);
       disableDefaultInteractivity(axes1);
       deleteAxesToolbar(axes1);

%       linkaxes([axes1 axes1r],'xy');
%       uistack(axes1r, 'top');

       axes2f = ...
           axes(uiSagWindowPtr('get'), ...
                'Units'   , 'normalized', ...
                'Ydir'    , 'reverse', ...
                'xlimmode','manual',...
                'ylimmode','manual',...
                'zlimmode','manual',...
                'climmode','manual',...
                'alimmode','manual',...
                'Box'     , 'off', ...
                'Position', [0 0 1 1], ...
                'color','none',...
                'Visible' , 'off'...
                );
       axes2f.Interactions = [zoomInteraction regionZoomInteraction rulerPanInteraction];
       % axes2f.Toolbar.Visible = 'off';
       axes2fPtr('set', axes2f, 1);
       disableDefaultInteractivity(axes2f);
       deleteAxesToolbar(axes2f);

       axes2fc = ...
           axes(uiSagWindowPtr('get'), ...
                'Units'   , 'normalized', ...
                'Ydir'    , 'reverse', ...
                'xlimmode','manual',...
                'ylimmode','manual',...
                'zlimmode','manual',...
                'climmode','manual',...
                'alimmode','manual',...
                'Box'     , 'off', ...
                'Position', [0 0 1 1], ...
                'color','none',...
                'Visible' , 'off'...
                );
       axes2fc.Interactions = [zoomInteraction regionZoomInteraction rulerPanInteraction];
       % axes2fc.Toolbar.Visible = 'off';
       axes2fcPtr('set', axes2fc, 1);
       disableDefaultInteractivity(axes2fc);
       deleteAxesToolbar(axes2fc);

%       axes2r = ...
%           axes(uiSagWindowPtr('get'), ...
%                'Units'   , 'normalized', ...
%                'Ydir'    , 'reverse', ...
%                'xlimmode', 'manual',...
%                'ylimmode', 'manual',...
%                'zlimmode', 'manual',...
%                'climmode', 'manual',...
%                'alimmode', 'manual',...
%                'Position', [0 0 1 1], ...
%                'Visible' , 'off'...
%                );
%       axis(axes2r, 'equal');
%       axes2rPtr('set', axes2r, 1);

       axes2 = ...
           axes(uiSagWindowPtr('get'), ...
                'Units'   , 'normalized', ...
                'xlimmode', 'manual',...
                'Ydir'    , 'reverse', ...
                'ylimmode', 'manual',...
                'zlimmode', 'manual',...
                'climmode', 'manual',...
                'alimmode', 'manual',...
                'Box'     , 'off', ...
                'Position', [0 0 1 1], ...
                'Visible' , 'off'...
               );
       axes2.Interactions = [zoomInteraction regionZoomInteraction rulerPanInteraction];
       % axes2.Toolbar.Visible = 'off';
       axes2Ptr('set', axes2, 1);
       disableDefaultInteractivity(axes2);
       deleteAxesToolbar(axes2);

%       linkaxes([axes2 axes2r],'xy');
%       uistack(axes2r, 'top');

       axes3f = ...
           axes(uiTraWindowPtr('get'), ...
                'Units'   , 'normalized', ...
                'Ydir'    , 'reverse', ...
                'xlimmode','manual',...
                'ylimmode','manual',...
                'zlimmode','manual',...
                'climmode','manual',...
                'alimmode','manual',...
                'Position', [0 0 1 1], ...
                'Box'     , 'off', ...
                'color'   ,'none',...
                'Visible' , 'off'...
                );
       axes3f.Interactions = [zoomInteraction regionZoomInteraction rulerPanInteraction];
       % axes3f.Toolbar.Visible = 'off';
       axes3fPtr('set', axes3f, 1);
       disableDefaultInteractivity(axes3f);
       deleteAxesToolbar(axes3f);

       axes3fc = ...
           axes(uiTraWindowPtr('get'), ...
                'Units'   , 'normalized', ...
                'Ydir'    , 'reverse', ...
                'xlimmode','manual',...
                'ylimmode','manual',...
                'zlimmode','manual',...
                'climmode','manual',...
                'alimmode','manual',...
                'Position', [0 0 1 1], ...
                'Box'     , 'off', ...
                'color'   ,'none',...
                'Visible' , 'off'...
                );
       axes3fc.Interactions = [zoomInteraction regionZoomInteraction rulerPanInteraction];
       % axes3fc.Toolbar.Visible = 'off';
       axes3fcPtr('set', axes3fc, 1);
       disableDefaultInteractivity(axes3fc);
       deleteAxesToolbar(axes3fc);

%       axes3r = ...
%           axes(uiTraWindowPtr('get'), ...
%                'Units'   , 'normalized', ...
%                'Ydir'    , 'reverse', ...
%                'xlimmode', 'manual',...
%                'ylimmode', 'manual',...
%                'zlimmode', 'manual',...
%                'climmode', 'manual',...
%                'alimmode', 'manual',...
%                'Position', [0 0 1 1], ...
%                'Visible' , 'off'...
%                );
%       axis(axes3r, 'equal');
%       axes3rPtr('set', axes3r, 1);
       axesColorbar = ...
            uiaxes(uiTraWindowPtr('get'), ...
                 'Units'   , 'pixels', ...
                 'Position', [0 0 1 1], ...
                 'Visible' , 'on', ...
                 'Ydir'    , 'normal', ...
                 'Tag'     , 'colorbar', ...
                 'Box'     , 'off', ...
                 'XLim'    , [0 inf], ...
                 'YLim'    , [0 inf], ...
                 'CLim'    , [0 inf] ...
                 );
        axesColorbar.Interactions = [];
        % axesColorbar.Toolbar.Visible = 'off';
        axesColorbarPtr('set', axesColorbar, 1);
        disableDefaultInteractivity(axesColorbar);
        deleteAxesToolbar(axesColorbar);

        axesFusionColorbar = ...
            uiaxes(uiTraWindowPtr('get'), ...
                 'Units'   , 'pixels', ...
                 'Position', [0 0 1 1], ...
                 'Visible' , 'on', ...
                 'Ydir'    , 'normal', ...
                 'Tag'     , 'fusion colorbar', ...
                 'Box'     , 'off', ...
                 'XLim'    , [0 inf], ...
                 'YLim'    , [0 inf], ...
                 'CLim'    , [0 inf] ...
                 );
        axesFusionColorbar.Interactions = [];
        % axesFusionColorbar.Toolbar.Visible = 'off';
        axesFusionColorbarPtr('set', axesFusionColorbar, 1);
        disableDefaultInteractivity(axesFusionColorbar);
        deleteAxesToolbar(axesFusionColorbar);

       axes3 = ...
           axes(uiTraWindowPtr('get'), ...
                'Units'   , 'normalized', ...
                'Ydir'    , 'reverse', ...
                'xlimmode', 'manual',...
                'ylimmode', 'manual',...
                'zlimmode', 'manual',...
                'climmode', 'manual',...
                'alimmode', 'manual',...
                'Box'     , 'off', ...
                'Position', [0 0 1 1], ...
                'Visible' , 'off'...
               );
       axes3.Interactions = [zoomInteraction regionZoomInteraction rulerPanInteraction];
       % axes3.Toolbar.Visible = 'off';
       axes3Ptr('set', axes3, 1);
       disableDefaultInteractivity(axes3);
       deleteAxesToolbar(axes3);

%       linkaxes([axes3 axes3r],'xy');
%       uistack(axes3r, 'top');

       axesMipf = ...
           axes(uiMipWindowPtr('get'), ...
                'Units'   , 'normalized', ...
                'Ydir'    , 'reverse', ...
                'xlimmode','manual',...
                'ylimmode','manual',...
                'zlimmode','manual',...
                'climmode','manual',...
                'alimmode','manual',...
                'Position', [0 0 1 1], ...
                'Box'     , 'off', ...
                'color'   ,'none',...
                'Visible' , 'off'...
                );
       axesMipf.Interactions = [zoomInteraction regionZoomInteraction rulerPanInteraction];
       % axesMipf.Toolbar.Visible = 'off';
       axesMipfPtr('set', axesMipf, 1);
       disableDefaultInteractivity(axesMipf);
       deleteAxesToolbar(axesMipf);

       axesMipfc = ...
           axes(uiMipWindowPtr('get'), ...
                'Units'   , 'normalized', ...
                'Ydir'    , 'reverse', ...
                'xlimmode','manual',...
                'ylimmode','manual',...
                'zlimmode','manual',...
                'climmode','manual',...
                'alimmode','manual',...
                'Position', [0 0 1 1], ...
                'Box'     , 'off', ...
                'color'   ,'none',...
                'Visible' , 'off'...
                );
       axesMipfc.Interactions = [zoomInteraction regionZoomInteraction rulerPanInteraction];
       % axesMipfc.Toolbar.Visible = 'off';
       axesMipfcPtr('set', axesMipfc, 1);
       disableDefaultInteractivity(axesMipfc);
       deleteAxesToolbar(axesMipfc);

       axesMip = ...
           axes(uiMipWindowPtr('get'), ...
                'Units'   , 'normalized', ...
                'Ydir'    , 'reverse', ...
                'xlimmode', 'manual',...
                'ylimmode', 'manual',...
                'zlimmode', 'manual',...
                'climmode', 'manual',...
                'alimmode', 'manual',...
                'Box'     , 'off', ...
                'Position', [0 0 1 1], ...
                'Visible' , 'off'...
               );
       axesMip.Interactions = [zoomInteraction regionZoomInteraction rulerPanInteraction];
       % axesMip.Toolbar.Visible = 'off';
       axesMipPtr('set', axesMip, 1);
       disableDefaultInteractivity(axesMip);
       deleteAxesToolbar(axesMip);

    end

    if(numel(dicomBuffer('get', [], get(uiSeriesPtr('get'), 'Value'))))

        % Deactivate main tool bar
        set(uiSeriesPtr('get'), 'Enable', 'off');
        mainToolBarEnable('off');

        clearDisplay();
        initDisplay(3);

%        link2DMip('set', true);

%        set(btnLinkMipPtr('get'), 'BackgroundColor', viewerButtonPushedBackgroundColor('get'));
%        set(btnLinkMipPtr('get'), 'ForegroundColor', viewerButtonPushedForegroundColor('get'));

        dicomViewerCore();

%        atMetaData = dicomMetaData('get');

        setViewerDefaultColor(true, dicomMetaData('get'));

        refreshImages();

%        if strcmpi(atMetaData{1}.Modality, 'ct')
%            link2DMip('set', false);

%            set(btnLinkMipPtr('get'), 'BackgroundColor', viewerBackgroundColor('get'));
%            set(btnLinkMipPtr('get'), 'ForegroundColor', viewerForegroundColor('get'));
%        end

        if size(dicomBuffer('get', [], get(uiSeriesPtr('get'), 'Value')), 3) ~= 1 || ... % 3D image
           size(dicomBuffer('get', [], get(uiSeriesPtr('get'), 'Value')), 4) ~= 1        % Multi-frame screen capture

            setPlaybackToolbar('on');
        end

        setRoiToolbar('on');
        setPlotEditToolbar('on');

        % Reactivate main tool bar
        set(uiSeriesPtr('get'), 'Enable', 'on');
        mainToolBarEnable('on');
    end

    function setLinkMipCallback(~, ~)

        if link2DMip('get') == true
            link2DMip('set', false);
        else
            link2DMip('set', true);
        end

        if link2DMip('get') == true
            set(btnLinkMipPtr('get'), 'BackgroundColor', viewerButtonPushedBackgroundColor('get'));
            set(btnLinkMipPtr('get'), 'ForegroundColor', viewerButtonPushedForegroundColor('get'));

            set(btnLinkMipPtr('get'), 'CData', resizeTopBarIcon('link_mip_white.png'));           
        else
            set(btnLinkMipPtr('get'), 'BackgroundColor', viewerBackgroundColor('get'));
            set(btnLinkMipPtr('get'), 'ForegroundColor', viewerForegroundColor('get'));

            set(btnLinkMipPtr('get'), 'CData', resizeTopBarIcon('link_mip_grey.png'));           
        end

    end
end
